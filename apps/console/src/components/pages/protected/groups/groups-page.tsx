'use client'
import React, { useMemo, useState } from 'react'
import { PageHeading } from '@repo/ui/page-heading'
import GroupsTable from '@/components/pages/protected/groups/components/groups-table'
import { CreditCard as CardIcon, SearchIcon, Table as TableIcon } from 'lucide-react'
import GroupsCard from '@/components/pages/protected/groups/components/groups-cards'
import { Checkbox } from '@repo/ui/checkbox'
import { GetAllGroupsQueryVariables, GroupSettingVisibility, UserRole } from '@repo/codegen/src/schema'
import CreateGroupDialog from './components/dialogs/create-group-dialog'
import GroupDetailsSheet from './components/group-details-sheet'
import { Input } from '@repo/ui/input'
import { TableSort } from '@/components/shared/table-filter/table-sort'
import { TableFilter } from '@/components/shared/table-filter/table-filter'
import { FilterField, SelectFilterField } from '@/types'
import { useSession } from 'next-auth/react'
import { useDebounce } from '@uidotdev/usehooks'
import { useGetAllGroups } from '@/lib/graphql-hooks/groups'
import { GROUP_SORT_FIELDS } from '@/components/pages/protected/groups/table/table-config.ts'

export interface Group {
  id: string
  name: string
  description?: string
  tags: string[]
  visibility: GroupSettingVisibility
  members: {
    id: string
    user: {
      firstName?: string
      lastName?: string
      avatarFile?: { presignedURL?: string }
      avatarRemoteURL?: string
      role?: UserRole
      id: string
    }
  }[]
  isManaged: boolean
}

const filterFields: FilterField[] = [
  { key: 'name', label: 'Name', type: 'text' },
  {
    key: 'visibility',
    label: 'Visibility',
    type: 'select',
    options: [
      { label: 'Public', value: GroupSettingVisibility.PUBLIC },
      { label: 'Private', value: GroupSettingVisibility.PRIVATE },
    ],
  } as SelectFilterField,
]

const GroupsPage = () => {
  const [activeTab, setActiveTab] = useState<'table' | 'card'>('table')
  const [whereFilters, setWhereFilters] = useState<Record<string, any>>({})
  const [orderBy, setOrderBy] = useState<GetAllGroupsQueryVariables['orderBy']>()
  const [searchQuery, setSearchQuery] = useState('')
  const { data: session } = useSession()
  const debouncedSearchQuery = useDebounce(searchQuery, 300)
  const [showAutoGenerated, setShowAutoGenerated] = useState<boolean>(true)

  const IsMyGroups = false //TODO: add checkbox to trigger my groups / all groups

  const whereFilter = useMemo(() => {
    const conditions: Record<string, any> = {
      ...(IsMyGroups && session ? { hasMembersWith: [{ userID: session.user?.userId || '' }] } : {}),
      ...(!showAutoGenerated ? { isManaged: false } : {}),
      ...(debouncedSearchQuery ? { displayNameContainsFold: debouncedSearchQuery } : {}),
      ...whereFilters,
    }

    return conditions
  }, [IsMyGroups, session, showAutoGenerated, debouncedSearchQuery, whereFilters])

  const orderByFilter = useMemo(() => {
    return orderBy || undefined
  }, [orderBy])

  const { data, isError, isPending } = useGetAllGroups(whereFilter, orderByFilter)
  return (
    <>
      <PageHeading heading={'Groups'} />
      <div className="flex justify-between">
        <div className="flex items-center gap-5">
          <div className="flex gap-1 size-fit bg-transparent py-0.5 px-1 border rounded-md">
            <div className={`py-1.5 px-2.5 rounded-md cursor-pointer ${activeTab === 'table' ? 'bg-card' : 'bg-transparent'}`} onClick={() => setActiveTab('table')}>
              <TableIcon size={16} />
            </div>
            <div className={`py-1.5 px-2.5 rounded-md cursor-pointer ${activeTab === 'card' ? 'bg-card' : 'bg-transparent'}`} onClick={() => setActiveTab('card')}>
              <CardIcon size={16} />
            </div>
          </div>
          <TableFilter filterFields={filterFields} onFilterChange={setWhereFilters} />
          <TableSort sortFields={GROUP_SORT_FIELDS} onSortChange={setOrderBy} />
          <Input
            value={searchQuery}
            name="groupSearch"
            placeholder="Search..."
            onChange={(e) => setSearchQuery(e.currentTarget.value)}
            icon={<SearchIcon width={17} />}
            iconPosition="left"
            variant="searchTable"
          />
          <div className="flex gap-2">
            <Checkbox checked={showAutoGenerated} onCheckedChange={(val: boolean) => setShowAutoGenerated(val)} />
            <p>Show auto generated group</p>
          </div>
        </div>
        <CreateGroupDialog />
      </div>

      {activeTab === 'table' ? <GroupsTable queryResult={data} isError={isError} /> : <GroupsCard isError={isError} isPending={isPending} queryResult={data} />}
      <GroupDetailsSheet />
    </>
  )
}

export default GroupsPage
